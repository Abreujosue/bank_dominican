
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bank Dominican | Banca en Línea</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --navy: #09203f;
            --accent: #0b66ff;
            --accent-hover: #0052cc;
            --gold: #d4af37;
            --bg: #f4f7fb;
            --card: #ffffff;
            --muted: #6b7686;
            --border: #e9ecef;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --shadow-lg: 0 16px 48px rgba(11, 102, 255, 0.1);
            --shadow-md: 0 8px 24px rgba(11, 26, 47, 0.07);
            --shadow-sm: 0 4px 12px rgba(11, 26, 47, 0.05);
            --font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* --- Base & Reset --- */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            font-family: var(--font-family); 
            background: var(--bg); 
            color: #071427; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        a { text-decoration: none; color: var(--accent); }
        a:hover { color: var(--accent-hover); }
        h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 700; }
        .view { display: none; }
        .view.active { display: block; }
        .small-muted { color: var(--muted); font-size: 0.9rem; }

        /* --- Loader --- */
        #loader {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        /* --- Auth Container --- */
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .auth-panel {
            width: 100%;
            max-width: 480px;
            padding: 28px 32px;
            border-radius: var(--radius-lg);
            background: var(--card);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }
        .auth-brand { text-align: center; margin-bottom: 24px; }
        .auth-brand .logo {
            width: 64px; height: 64px; border-radius: 16px;
            background: linear-gradient(135deg, var(--accent), #66b2ff);
            color: #fff; display: inline-grid; place-items: center;
            font-weight: 900; font-size: 28px; box-shadow: var(--shadow-md);
            margin-bottom: 12px;
        }
        .auth-brand .title { font-weight: 800; font-size: 24px; }
        .auth-brand .subtitle { color: var(--muted); }
        .auth-footer { text-align: center; margin-top: 24px; color: var(--muted); font-size: 0.85rem; }

        /* --- App Container --- */
        .app-shell { display: flex; min-height: 100vh; }
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #fff, #fbfdff);
            border-right: 1px solid var(--border);
            padding: 24px;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }
        .sidebar .brand {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 24px; padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        .brand .logo {
            width: 48px; height: 48px; border-radius: 12px;
            background: linear-gradient(135deg, var(--accent), #66b2ff);
            color: #fff; display: grid; place-items: center;
            font-weight: 900; font-size: 20px; box-shadow: var(--shadow-md);
            flex-shrink: 0;
        }
        .brand .title-group .title { font-weight: 800; font-size: 18px; letter-spacing: .3px; }
        .brand .title-group .sub { color: var(--muted); font-size: 0.88rem; }
        .nav-list { margin: 0; padding: 0; list-style: none; display: flex; flex-direction: column; gap: 8px; }
        .nav-item {
            display: flex; align-items: center; gap: 14px;
            padding: 12px 16px; border-radius: var(--radius-md);
            color: #344054; font-weight: 600; font-size: 0.95rem;
            transition: all .2s ease; cursor: pointer;
        }
        .nav-item:hover { background: var(--bg); color: var(--accent); transform: translateX(2px); }
        .nav-item.active {
            background: var(--accent); color: #fff;
            box-shadow: 0 8px 24px rgba(11, 102, 255, 0.15);
        }
        .nav-item .nav-icon { font-size: 1.2rem; }
        .sidebar-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border); }

        /* Main Area */
        .main { flex: 1; padding: 24px 32px; overflow-x: hidden; }
        .topbar {
            display: flex; justify-content: space-between; align-items: center;
            gap: 16px; margin-bottom: 24px;
        }
        .page-header h1 { font-size: 28px; font-weight: 800; }
        .page-header p { color: var(--muted); margin-top: 4px; }
        
        .top-actions { display: flex; align-items: center; gap: 16px; }
        .search-input { width: 360px; max-width: 40vw; }
        .profile-dropdown .dropdown-toggle::after { display: none; }
        .profile-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--navy); color: white; display: grid; place-items: center;
            font-weight: 600; cursor: pointer;
        }

        /* --- Components --- */
        .card {
            border-radius: var(--radius-lg);
            background: var(--card);
            box-shadow: var(--shadow-sm);
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.2s ease-in-out;
        }
        .card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .card-header {
            padding: 0 0 16px; margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-title { font-size: 1.1rem; font-weight: 700; }
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
        .table-responsive { border: 1px solid var(--border); border-radius: var(--radius-md); }
        .table { margin-bottom: 0; }
        .table th { font-weight: 600; color: var(--muted); font-size: 0.85rem; text-transform: uppercase; }
        .btn-primary { background-color: var(--accent); border-color: var(--accent); }
        .btn-primary:hover { background-color: var(--accent-hover); border-color: var(--accent-hover); }
        .form-control:focus, .form-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 0.25rem rgba(11, 102, 255, 0.25);
        }

        /* --- Responsive --- */
        @media (max-width: 992px) {
            .sidebar { width: 80px; }
            .sidebar .brand .title-group, .sidebar .nav-item span:last-child, .sidebar-footer div { display: none; }
            .sidebar .brand { justify-content: center; }
            .sidebar .nav-item { justify-content: center; }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .app-shell { flex-direction: column; }
            .topbar { flex-direction: column; align-items: flex-start; gap: 12px; }
            .main { padding: 16px; }
        }
    </style>
</head>
<body>
    
    <div id="loader">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <div id="auth-container" class="auth-container">
        <div class="auth-brand">
            <div class="logo">BD</div>
            <div class="title">Bank Dominican</div>
            <div class="subtitle">Tu banca en línea, segura y confiable.</div>
        </div>
        
        <section id="view_login" class="view auth-panel">
            <h3 class="text-center mb-1">Iniciar Sesión</h3>
            <p class="text-center small-muted mb-4">Ingresa tus credenciales para acceder a tu panel.</p>
            <div id="login_alert_box" class="mb-3"></div>
            <form id="login_form">
                <div class="mb-3">
                    <label for="login_username" class="form-label small-muted">Usuario</label>
                    <input id="login_username" class="form-control form-control-lg" placeholder="ej: admin">
                </div>
                <div class="mb-3">
                    <label for="login_password" class="form-label small-muted">Contraseña</label>
                    <input id="login_password" type="password" class="form-control form-control-lg" placeholder="••••••••">
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="login_remember">
                        <label class="form-check-label small-muted" for="login_remember">Recordarme</label>
                    </div>
                    <a href="#/recover" class="small">¿Olvidaste tu contraseña?</a>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">Entrar</button>
                    <button id="action_fill_admin" type="button" class="btn btn-outline-secondary">Usar datos de demostración</button>
                </div>
            </form>
            <p class="text-center small-muted mt-4">¿No tienes cuenta? <a href="#/register">Crea una ahora</a></p>
        </section>

        <section id="view_register" class="view auth-panel">
            <h3 class="text-center mb-1">Crear Cuenta</h3>
            <p class="text-center small-muted mb-4">Completa el formulario para unirte.</p>
            <div id="register_alert_box" class="mb-3"></div>
            <form id="register_form">
                <div class="mb-3">
                    <label class="form-label small-muted">Usuario</label>
                    <input id="reg_username" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label small-muted">Correo Electrónico</label>
                    <input id="reg_email" type="email" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label small-muted">Contraseña</label>
                    <input id="reg_password" type="password" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label small-muted">Confirmar Contraseña</label>
                    <input id="reg_password2" type="password" class="form-control" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">Registrarme</button>
                </div>
            </form>
            <p class="text-center small-muted mt-4">¿Ya tienes cuenta? <a href="#/login">Inicia sesión</a></p>
        </section>

        <section id="view_recover" class="view auth-panel">
            <h3 class="text-center mb-1">Recuperar Contraseña</h3>
            <p class="text-center small-muted mb-4">Ingresa tu correo y te enviaremos instrucciones.</p>
            <div id="recover_alert_box" class="mb-3"></div>
            <form id="recover_form">
                <div class="mb-3">
                    <label class="form-label small-muted">Correo Electrónico</label>
                    <input id="recover_email" type="email" class="form-control form-control-lg" required>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">Enviar Instrucciones</button>
                    <a href="#/login" class="btn btn-outline-secondary">Volver a Inicio de Sesión</a>
                </div>
            </form>
        </section>

        <footer class="auth-footer">
            Bank Dominican &copy; <span id="year1"></span>. Todos los derechos reservados.
        </footer>
    </div>

    <div id="app-container" class="app-shell" style="display: none;">
        <aside class="sidebar" aria-label="Navegación principal">
            <div class="brand">
                <div class="logo">BD</div>
                <div class="title-group">
                    <div class="title">Bank Dominican</div>
                    <div class="sub">Banca en Línea</div>
                </div>
            </div>

            <nav aria-label="Menú principal">
                <ul class="nav-list" id="sidebar_nav">
                    <li><a class="nav-item" data-view="dashboard" href="#/dashboard"><span class="nav-icon">📊</span> <span>Dashboard</span></a></li>
                    <li><a class="nav-item" data-view="exchange" href="#/exchange"><span class="nav-icon">💱</span> <span>Cambio y Pagos</span></a></li>
                    <li><a class="nav-item" data-view="accounts" href="#/accounts"><span class="nav-icon">🏦</span> <span>Cuentas</span></a></li>
                    <li><a class="nav-item" data-view="cards" href="#/cards"><span class="nav-icon">💳</span> <span>Tarjetas</span></a></li>
                    <li><a class="nav-item" data-view="history" href="#/history"><span class="nav-icon">📜</span> <span>Historial</span></a></li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <ul class="nav-list">
                    <li><a class="nav-item" data-view="profile" href="#/profile"><span class="nav-icon">👤</span> <span>Mi Perfil</span></a></li>
                    <li><a class="nav-item" data-view="settings" href="#/settings"><span class="nav-icon">⚙️</span> <span>Ajustes</span></a></li>
                    <li><a class="nav-item" href="#" id="action_logout"><span class="nav-icon">🚪</span> <span>Cerrar Sesión</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main" id="main_content">
            <header class="topbar">
                <div class="page-header" id="page_header">
                    <h1>Dashboard</h1>
                    <p>Bienvenido de nuevo, <span id="user_name_header"></span></p>
                </div>
                <div class="top-actions">
                    <div class="input-group search-input" role="search">
                        <span class="input-group-text">🔍</span>
                        <input id="input_search" type="text" class="form-control" placeholder="Buscar transacciones...">
                    </div>
                    <div class="dropdown profile-dropdown">
                        <div id="user_avatar" class="profile-avatar dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"></div>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header" id="dropdown_username"></h6></li>
                            <li><p class="dropdown-header small-muted" id="dropdown_useremail" style="margin-top:-8px;"></p></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#/profile">Mi Perfil</a></li>
                            <li><a class="dropdown-item" href="#/settings">Ajustes</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" id="action_logout_dropdown" href="#">Cerrar Sesión</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <div id="view_container">
                <section id="view_dashboard" class="view">
                    <div class="grid-layout">
                           <div class="card bg-primary text-white">
                               <h5>Saldo Total (DOP)</h5>
                               <p class="h2 fw-bold" id="dash_total_balance">$0.00</p>
                               <small>Suma de todas tus cuentas en pesos.</small>
                           </div>
                           <div class="card">
                               <h5>Tasa de Cambio</h5>
                               <p class="h3" id="dash_exchange_rate">1 USD = $0.00 DOP</p>
                               <small class="small-muted">Actualizada: <span id="dash_rate_updated"></span></small>
                           </div>
                           <div class="card">
                               <h5>Último Pago Realizado</h5>
                               <p class="h3" id="dash_last_payment">$0.00 USD</p>
                               <small class="small-muted" id="dash_last_payment_date">No hay pagos recientes.</small>
                           </div>
                    </div>
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="card-title">Operación Rápida</h5>
                        </div>
                        <div class="card-body">
                             <p>Realiza un pago rápido a tu tarjeta de crédito en USD.</p>
                             <a href="#/exchange" class="btn btn-primary">Ir a Pagos</a>
                        </div>
                    </div>
                     <div class="card mt-4">
                         <div class="card-header">
                             <h5 class="card-title">Actividad Reciente</h5>
                             <a href="#/history" class="btn btn-sm btn-outline-primary">Ver todo</a>
                         </div>
                         <div class="card-body p-0">
                             <div class="table-responsive">
                                 <table class="table">
                                      <tbody id="dash_recent_activity">
                                          </tbody>
                                     </table>
                                  </div>
                              </div>
                          </div>
                      </section>
                      
                      <section id="view_exchange" class="view">
                           <div class="row">
                              <div class="col-lg-8">
                                   <div class="card">
                                       <div class="card-header"><h5 class="card-title">Realizar Pago de Tarjeta en USD</h5></div>
                                       <div class="card-body">
                                           <div id="exchange_alert_box" class="mb-3"></div>
                                           <form id="exchange_form">
                                               <div class="row g-3">
                                                   <div class="col-md-6">
                                                       <label class="form-label">Monto a pagar (USD)</label>
                                                       <input id="ex_monto_usd" type="number" class="form-control" value="100" step="0.01" min="0" required>
                                                   </div>
                                                   <div class="col-md-6">
                                                       <label class="form-label">Cuenta de Origen (DOP)</label>
                                                       <select id="ex_select_account" class="form-select" required></select>
                                                   </div>
                                                   <div class="col-12">
                                                       <label class="form-label">Tarjeta a Pagar (USD)</label>
                                                       <select id="ex_select_card" class="form-select" required></select>
                                                   </div>
                                               </div>
                                           </form>
                                       </div>
                                   </div>
                               </div>
                               <div class="col-lg-4">
                                     <div class="card">
                                        <div class="card-header"><h5 class="card-title">Resumen de la Operación</h5></div>
                                        <div id="ex_summary" class="card-body">
                                            <p class="small-muted">Completa el formulario para ver el resumen.</p>
                                        </div>
                                        <div class="card-footer bg-transparent" id="ex_confirm_footer" style="display:none;">
                                            <div class="d-grid">
                                                <button id="ex_pay_btn" type="button" class="btn btn-success">Confirmar y Pagar</button>
                                            </div>
                                        </div>
                                     </div>
                               </div>
                           </div>
                       </section>

                       <section id="view_accounts" class="view">
                            <div id="accounts_list" class="grid-layout">
                                </div>
                       </section>

                       <section id="view_cards" class="view">
                            <div id="cards_list" class="grid-layout">
                                 </div>
                       </section>

                       <section id="view_history" class="view">
                           <div class="card">
                               <div class="card-header">
                                   <h5 class="card-title">Historial de Transacciones</h5>
                                   <button id="history_clear_btn" class="btn btn-sm btn-outline-danger">Limpiar Historial</button>
                               </div>
                               <div class="card-body p-0">
                                     <div class="table-responsive">
                                        <table class="table table-hover">
                                             <thead>
                                                 <tr>
                                                     <th>Fecha</th>
                                                     <th>Descripción</th>
                                                     <th>Monto (USD)</th>
                                                     <th>Monto (DOP)</th>
                                                     <th>Tasa</th>
                                                     <th>Cuenta Origen</th>
                                                 </tr>
                                             </thead>
                                             <tbody id="history_table_body">
                                                 </tbody>
                                         </table>
                                     </div>
                               </div>
                               <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
                                    <span id="pagination_info" class="small-muted"></span>
                                     <nav>
                                         <ul class="pagination" style="margin-bottom:0;">
                                             <li class="page-item"><a class="page-link" href="#" id="pagination_prev">Anterior</a></li>
                                             <li class="page-item"><a class="page-link" href="#" id="pagination_next">Siguiente</a></li>
                                         </ul>
                                     </nav>
                               </div>
                           </div>
                       </section>
                       
                       <section id="view_profile" class="view">
                           <div class="card">
                               <div class="card-header"><h5 class="card-title">Mi Perfil</h5></div>
                               <div class="card-body">
                                     <div id="profile_alert_box"></div>
                                    <form id="profile_form">
                                        <div class="mb-3">
                                            <label class="form-label">Nombre de Usuario</label>
                                            <input type="text" id="profile_username" class="form-control" disabled>
                                            <div class="form-text">El nombre de usuario no se puede cambiar.</div>
                                        </div>
                                         <div class="mb-3">
                                            <label class="form-label">Nombre Completo</label>
                                            <input type="text" id="profile_fullname" class="form-control">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Correo Electrónico</label>
                                            <input type="email" id="profile_email" class="form-control">
                                        </div>
                                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                                    </form>
                               </div>
                           </div>
                       </section>

                       <section id="view_settings" class="view">
                            <div class="card">
                                <div class="card-header"><h5 class="card-title">Ajustes de la Aplicación</h5></div>
                                <div class="card-body">
                                    <div id="settings_alert_box"></div>
                                    <form id="settings_form">
                                        <div class="mb-4">
                                            <h6>Tema Visual</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="theme" id="theme_light" checked>
                                                <label class="form-check-label" for="theme_light">Claro (Predeterminado)</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="theme" id="theme_dark" disabled>
                                                <label class="form-check-label" for="theme_dark">Oscuro (Próximamente)</label>
                                            </div>
                                        </div>
                                        <div class="mb-4">
                                            <h6>Notificaciones por Correo</h6>
                                             <div class="form-check form-switch">
                                                 <input class="form-check-input" type="checkbox" role="switch" id="setting_notif_payments" checked>
                                                 <label class="form-check-label" for="setting_notif_payments">Confirmación de pagos</label>
                                             </div>
                                             <div class="form-check form-switch">
                                                 <input class="form-check-input" type="checkbox" role="switch" id="setting_notif_news">
                                                 <label class="form-check-label" for="setting_notif_news">Novedades y promociones</label>
                                             </div>
                                         </div>
                                         <button type="submit" class="btn btn-primary">Guardar Ajustes</button>
                                     </form>
                                 </div>
                             </div>
                         </section>

                     </div>

                     <footer class="text-center text-muted mt-4">
                         Bank Dominican &copy; <span id="year2"></span>
                     </footer>
                 </main>
             </div>

             <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

            <script>
            document.addEventListener('DOMContentLoaded', () => {

                // --- CONFIG & CONSTANTS ---
                const DB_PREFIX = 'bd_pro_';
                const KEY_USERS = `${DB_PREFIX}users`;
                const KEY_SESSION = `${DB_PREFIX}session`;
                const KEY_APP_STATE = `${DB_PREFIX}app_state`;
                const HISTORY_PAGE_SIZE = 5;

                // --- DOM UTILITIES ---
                const $ = id => document.getElementById(id);
                const qs = sel => document.querySelector(sel);
                const qsa = sel => Array.from(document.querySelectorAll(sel));
                const now = () => new Date().toLocaleString('es-DO');
                const money = (n, currency = 'DOP') => {
                    return Number(n).toLocaleString('es-DO', { 
                        style: 'currency', 
                        currency: currency,
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 2 
                    });
                };

                const showAlert = (targetId, message, type = 'info') => {
                    const el = $(targetId);
                    if (!el) return;
                    const alertClass = `alert-${type}`;
                    el.innerHTML = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`;
                };

                const hideLoader = () => {
                    const loader = $('loader');
                    if (loader) {
                        loader.style.display = 'none';
                    }
                };

                const showLoader = () => {
                    const loader = $('loader');
                    if (loader) {
                        loader.style.display = 'flex';
                    }
                };

                const generateId = () => Math.random().toString(36).substring(2, 10);
                const getInitials = (name) => {
                    if (!name) return 'U';
                    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                };
                
                // --- DATA & STATE MANAGEMENT (STORE) ---
                const store = {
                    state: {
                        user: null,
                        appData: {
                            accounts: [],
                            cards: [],
                            history: [],
                            exchangeRate: { rate: 58.75, updated: now() },
                            lastPayment: null,
                        },
                        historyPage: 0,
                        currentTransaction: null
                    },
                    init() {
                        this.setupDemoUser();
                        const storedState = JSON.parse(localStorage.getItem(KEY_APP_STATE));
                        if (storedState) {
                            this.state.appData = { ...this.state.appData, ...storedState };
                        } else {
                            this.state.appData.accounts = [
                                { id: generateId(), name: 'Cuenta de Ahorros', balance: 150000, currency: 'DOP' },
                                { id: generateId(), name: 'Cuenta Corriente', balance: 75000, currency: 'DOP' },
                                { id: generateId(), name: 'Cuenta en Dólares', balance: 1250, currency: 'USD' }
                            ];
                            this.state.appData.cards = [
                                { id: generateId(), name: 'Visa Gold', balance: 800, currency: 'USD', minPayment: 25 },
                                { id: generateId(), name: 'MasterCard Platinum', balance: 150, currency: 'USD', minPayment: 10 }
                            ];
                            this.save();
                        }
                    },
                    setupDemoUser() {
                        let users = JSON.parse(localStorage.getItem(KEY_USERS) || '[]');
                        if (!users.find(u => u.username === 'admin')) {
                            const demoUser = { username: 'admin', email: 'admin@bank.com', password: 'password123', name: 'Demo User', id: generateId() };
                            users.push(demoUser);
                            localStorage.setItem(KEY_USERS, JSON.stringify(users));
                        }
                    },
                    login(user) {
                        this.state.user = user;
                        localStorage.setItem(KEY_SESSION, JSON.stringify(user));
                    },
                    logout() {
                        this.state.user = null;
                        localStorage.removeItem(KEY_SESSION);
                    },
                    isLoggedIn() {
                        const session = localStorage.getItem(KEY_SESSION);
                        if (session) {
                            this.state.user = JSON.parse(session);
                            return true;
                        }
                        return false;
                    },
                    save() {
                        localStorage.setItem(KEY_APP_STATE, JSON.stringify(this.state.appData));
                    },
                    addTransaction(transaction) {
                        this.state.appData.history.unshift(transaction);
                        this.state.appData.lastPayment = transaction;
                        this.save();
                    }
                };

                // --- TEMPLATE RENDERING ---
                const renderDashboard = () => {
                    const totalDOP = store.state.appData.accounts
                        .filter(acc => acc.currency === 'DOP')
                        .reduce((sum, acc) => sum + acc.balance, 0);

                    const lastPayment = store.state.appData.lastPayment;

                    const dashTotalBalance = $('dash_total_balance');
                    const dashExchangeRate = $('dash_exchange_rate');
                    const dashRateUpdated = $('dash_rate_updated');
                    const dashLastPayment = $('dash_last_payment');
                    const dashLastPaymentDate = $('dash_last_payment_date');

                    if (dashTotalBalance) dashTotalBalance.innerText = money(totalDOP, 'DOP');
                    if (dashExchangeRate) dashExchangeRate.innerText = `1 USD = ${money(store.state.appData.exchangeRate.rate, 'DOP')} DOP`;
                    if (dashRateUpdated) dashRateUpdated.innerText = store.state.appData.exchangeRate.updated;

                    if (lastPayment) {
                        if (dashLastPayment) dashLastPayment.innerText = money(lastPayment.amount, lastPayment.currency);
                        if (dashLastPaymentDate) dashLastPaymentDate.innerText = lastPayment.date;
                    }

                    const recentActivity = store.state.appData.history.slice(0, 5);
                    const historyBody = $('dash_recent_activity');
                    if (historyBody) {
                        historyBody.innerHTML = recentActivity.map(t => `
                            <tr>
                                <td>${t.date}</td>
                                <td>${t.description}</td>
                                <td class="text-end">${money(t.amount, t.currency)}</td>
                            </tr>
                        `).join('') || `<tr><td colspan="3" class="text-center text-muted">No hay actividad reciente.</td></tr>`;
                    }
                };

                const renderAccounts = () => {
                    const accountsList = $('accounts_list');
                    if (!accountsList) return;
                    accountsList.innerHTML = store.state.appData.accounts.map(acc => `
                        <div class="card">
                            <div class="card-header d-flex justify-content-between">
                                <h5 class="card-title">${acc.name}</h5>
                                <small class="small-muted">${acc.currency}</small>
                            </div>
                            <div class="card-body">
                                <p class="h3 fw-bold">${money(acc.balance, acc.currency)}</p>
                                <small>Balance disponible</small>
                            </div>
                        </div>
                    `).join('') || '<p class="text-center text-muted">No tienes cuentas disponibles.</p>';
                };

                const renderCards = () => {
                    const cardsList = $('cards_list');
                    if (!cardsList) return;
                    cardsList.innerHTML = store.state.appData.cards.map(card => `
                        <div class="card">
                            <div class="card-header d-flex justify-content-between">
                                <h5 class="card-title">${card.name}</h5>
                                <small class="small-muted">${card.currency}</small>
                            </div>
                            <div class="card-body">
                                <p class="h3 fw-bold">${money(card.balance, card.currency)}</p>
                                <small>Balance a pagar</small>
                            </div>
                        </div>
                    `).join('') || '<p class="text-center text-muted">No tienes tarjetas disponibles.</p>';
                };

                const renderHistory = () => {
                    const tableBody = $('history_table_body');
                    if (!tableBody) return;
                    
                    const historyData = store.state.appData.history;
                    const totalPages = Math.ceil(historyData.length / HISTORY_PAGE_SIZE);
                    const start = store.state.historyPage * HISTORY_PAGE_SIZE;
                    const end = start + HISTORY_PAGE_SIZE;
                    const paginatedData = historyData.slice(start, end);

                    tableBody.innerHTML = paginatedData.map(t => `
                        <tr>
                            <td>${t.date}</td>
                            <td>${t.description}</td>
                            <td>${t.amount ? money(t.amount, 'USD') : '-'}</td>
                            <td>${t.amountDOP ? money(t.amountDOP, 'DOP') : '-'}</td>
                            <td>${t.exchangeRate}</td>
                            <td>${t.sourceAccount}</td>
                        </tr>
                    `).join('') || `<tr><td colspan="6" class="text-center text-muted">No hay transacciones en el historial.</td></tr>`;

                    const paginationInfo = $('pagination_info');
                    if (paginationInfo) {
                        if (historyData.length > 0) {
                            const showingStart = start + 1;
                            const showingEnd = Math.min(end, historyData.length);
                            paginationInfo.innerText = `Mostrando ${showingStart} a ${showingEnd} de ${historyData.length} transacciones`;
                        } else {
                            paginationInfo.innerText = '';
                        }
                    }

                    const prevBtn = $('pagination_prev');
                    const nextBtn = $('pagination_next');
                    if (prevBtn) prevBtn.parentElement.classList.toggle('disabled', store.state.historyPage <= 0);
                    if (nextBtn) nextBtn.parentElement.classList.toggle('disabled', store.state.historyPage >= totalPages - 1);
                };

                const renderProfile = () => {
                    const user = store.state.user;
                    if (user) {
                        const profileUsername = $('profile_username');
                        const profileFullname = $('profile_fullname');
                        const profileEmail = $('profile_email');
                        
                        if (profileUsername) profileUsername.value = user.username;
                        if (profileFullname) profileFullname.value = user.name || '';
                        if (profileEmail) profileEmail.value = user.email;
                    }
                };

                const renderExchangeForm = () => {
                    const accountsSelect = $('ex_select_account');
                    const cardsSelect = $('ex_select_card');

                    if (accountsSelect) {
                        accountsSelect.innerHTML = store.state.appData.accounts
                            .filter(acc => acc.currency === 'DOP')
                            .map(acc => `<option value="${acc.id}">${acc.name} (${money(acc.balance, acc.currency)})</option>`)
                            .join('');
                    }

                    if (cardsSelect) {
                        cardsSelect.innerHTML = store.state.appData.cards
                            .map(card => `<option value="${card.id}">${card.name} (${money(card.balance, card.currency)} a pagar)</option>`)
                            .join('');
                    }

                    updateExchangeSummary();
                };
                
                // --- ROUTER & VIEW MANAGEMENT ---
                const showView = (viewId) => {
                    qsa('.view').forEach(view => view.classList.remove('active'));
                    
                    const view = $(`view_${viewId}`);
                    if (view) {
                        view.classList.add('active');
                        
                        const header = $('page_header');
                        if (header) {
                            const titles = {
                                dashboard: 'Dashboard',
                                exchange: 'Cambio y Pagos',
                                accounts: 'Mis Cuentas',
                                cards: 'Mis Tarjetas',
                                history: 'Historial de Transacciones',
                                profile: 'Mi Perfil',
                                settings: 'Ajustes'
                            };
                            
                            const subtitles = {
                                dashboard: `Bienvenido de nuevo, ${store.state.user?.name || store.state.user?.username || 'Usuario'}`,
                                exchange: 'Realiza pagos de tarjetas de crédito en USD',
                                accounts: 'Administra tus cuentas bancarias',
                                cards: 'Gestiona tus tarjetas de crédito',
                                history: 'Revisa todas tus transacciones',
                                profile: 'Actualiza tu información personal',
                                settings: 'Configura tu experiencia'
                            };
                            
                            header.innerHTML = `<h1>${titles[viewId] || viewId}</h1><p>${subtitles[viewId] || ''}</p>`;
                        }

                        qsa('.sidebar .nav-item').forEach(item => item.classList.remove('active'));
                        const activeLink = qs(`[data-view="${viewId}"]`);
                        if (activeLink) {
                            activeLink.classList.add('active');
                        }
                    }

                    switch (viewId) {
                        case 'dashboard': renderDashboard(); break;
                        case 'accounts': renderAccounts(); break;
                        case 'cards': renderCards(); break;
                        case 'history': renderHistory(); break;
                        case 'profile': renderProfile(); break;
                        case 'exchange': renderExchangeForm(); break;
                    }
                };

                const router = () => {
                    const hash = window.location.hash.substring(1) || '/login';
                    const route = hash.split('/')[1] || 'login';

                    if (store.isLoggedIn()) {
                        $('auth-container').style.display = 'none';
                        $('app-container').style.display = 'flex';
                        updateAppUI();
                        showView(route === 'login' ? 'dashboard' : route);
                    } else {
                        $('app-container').style.display = 'none';
                        $('auth-container').style.display = 'flex';
                        showView(route);
                    }
                };
                
                // --- APP UI UPDATES ---
                const updateAppUI = () => {
                    const user = store.state.user;
                    if (user) {
                        const userNameHeader = $('user_name_header');
                        if (userNameHeader) userNameHeader.innerText = user.name || user.username;
                        const userAvatar = $('user_avatar');
                        if (userAvatar) userAvatar.innerText = getInitials(user.name || user.username);
                        const dropdownUsername = $('dropdown_username');
                        if (dropdownUsername) dropdownUsername.innerText = user.name || user.username;
                        const dropdownUseremail = $('dropdown_useremail');
                        if (dropdownUseremail) dropdownUseremail.innerText = user.email;
                    }
                };

                // --- API SIMULATION ---
                const api = {
                    login: async (username, password) => {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        const users = JSON.parse(localStorage.getItem(KEY_USERS) || '[]');
                        const user = users.find(u => u.username === username && u.password === password);
                        if (user) {
                            store.login(user);
                            return { success: true, message: 'Inicio de sesión exitoso.' };
                        } else {
                            return { success: false, message: 'Usuario o contraseña incorrectos.' };
                        }
                    },
                    register: async (username, email, password) => {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        let users = JSON.parse(localStorage.getItem(KEY_USERS) || '[]');
                        if (users.find(u => u.username === username)) {
                            return { success: false, message: 'El nombre de usuario ya existe.' };
                        }
                        const newUser = { username, email, password, name: '', id: generateId() };
                        users.push(newUser);
                        localStorage.setItem(KEY_USERS, JSON.stringify(users));
                        return { success: true, message: 'Registro exitoso. Ahora puedes iniciar sesión.' };
                    },
                    payCreditCard: async (sourceAccountId, cardId, amount) => {
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        
                        const account = store.state.appData.accounts.find(acc => acc.id === sourceAccountId);
                        const card = store.state.appData.cards.find(c => c.id === cardId);
                        const exchangeRate = store.state.appData.exchangeRate.rate;
                        const amountDOP = amount * exchangeRate;

                        if (!account || !card) {
                            return { success: false, message: 'Cuenta o tarjeta no encontrada.' };
                        }

                        if (account.balance < amountDOP) {
                            return { success: false, message: 'Fondos insuficientes en la cuenta de origen.' };
                        }

                        if (card.balance < amount) {
                            return { success: false, message: 'El monto a pagar es mayor al balance de la tarjeta.' };
                        }

                        account.balance -= amountDOP;
                        card.balance -= amount;

                        const transaction = {
                            id: generateId(),
                            date: now(),
                            description: `Pago a tarjeta ${card.name}`,
                            amount: amount,
                            currency: 'USD',
                            amountDOP: amountDOP,
                            exchangeRate: exchangeRate,
                            sourceAccount: account.name
                        };

                        store.addTransaction(transaction);
                        store.save();

                        return { success: true, message: 'Pago realizado con éxito.' };
                    }
                };
                
                // --- EXCHANGE LOGIC ---
                const updateExchangeSummary = () => {
                    const montoInput = $('ex_monto_usd');
                    const accountSelect = $('ex_select_account');
                    const cardSelect = $('ex_select_card');
                    const summary = $('ex_summary');
                    const confirmFooter = $('ex_confirm_footer');

                    if (!montoInput || !accountSelect || !cardSelect || !summary || !confirmFooter) return;

                    const amountUSD = parseFloat(montoInput.value) || 0;
                    const exchangeRate = store.state.appData.exchangeRate.rate;
                    const account = store.state.appData.accounts.find(acc => acc.id === accountSelect.value);
                    const card = store.state.appData.cards.find(c => c.id === cardSelect.value);
                    const amountDOP = amountUSD * exchangeRate;

                    if (amountUSD > 0 && account && card) {
                        const canPay = account.balance >= amountDOP && card.balance >= amountUSD;
                        
                        summary.innerHTML = `
                            <p><strong>Monto a pagar (USD):</strong> ${money(amountUSD, 'USD')}</p>
                            <p><strong>Tasa de cambio:</strong> 1 USD = ${money(exchangeRate, 'DOP')} DOP</p>
                            <p><strong>Costo total (DOP):</strong> ${money(amountDOP, 'DOP')}</p>
                            <hr>
                            <p class="small-muted">Balance en cuenta: ${money(account.balance, 'DOP')}</p>
                            <p class="small-muted">Balance de tarjeta: ${money(card.balance, 'USD')}</p>
                            ${!canPay ? '<p class="text-danger small">Fondos insuficientes o monto mayor al balance de la tarjeta</p>' : ''}
                        `;
                        
                        confirmFooter.style.display = canPay ? 'block' : 'none';

                        if (canPay) {
                            store.state.currentTransaction = {
                                sourceAccountId: account.id,
                                cardId: card.id,
                                amount: amountUSD
                            };
                        } else {
                            store.state.currentTransaction = null;
                        }

                    } else {
                        summary.innerHTML = '<p class="small-muted">Completa el formulario para ver el resumen.</p>';
                        confirmFooter.style.display = 'none';
                        store.state.currentTransaction = null;
                    }
                };

                const bindEvents = () => {
                    // Login form
                    const loginForm = $('login_form');
                    if (loginForm) {
                        loginForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const username = $('login_username').value;
                            const password = $('login_password').value;

                            showLoader();
                            const result = await api.login(username, password);
                            hideLoader();

                            if (result.success) {
                                window.location.hash = '#/dashboard';
                            } else {
                                showAlert('login_alert_box', result.message, 'danger');
                            }
                        });
                    }

                    // Fill admin credentials
                    const fillAdminBtn = $('action_fill_admin');
                    if (fillAdminBtn) {
                        fillAdminBtn.addEventListener('click', () => {
                            $('login_username').value = 'admin';
                            $('login_password').value = 'password123';
                        });
                    }
                    
                    // Register form
                    const registerForm = $('register_form');
                    if (registerForm) {
                        registerForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const username = $('reg_username').value;
                            const email = $('reg_email').value;
                            const password = $('reg_password').value;
                            const password2 = $('reg_password2').value;
                            
                            if (password !== password2) {
                                showAlert('register_alert_box', 'Las contraseñas no coinciden.', 'danger');
                                return;
                            }
                            
                            showLoader();
                            const result = await api.register(username, email, password);
                            hideLoader();
                            
                            if (result.success) {
                                showAlert('register_alert_box', result.message, 'success');
                                registerForm.reset();
                            } else {
                                showAlert('register_alert_box', result.message, 'danger');
                            }
                        });
                    }

                    // Logout buttons
                    const logoutBtn = $('action_logout');
                    const logoutDropdown = $('action_logout_dropdown');
                    
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            store.logout();
                            window.location.hash = '#/login';
                        });
                    }

                    if (logoutDropdown) {
                        logoutDropdown.addEventListener('click', (e) => {
                            e.preventDefault();
                            store.logout();
                            window.location.hash = '#/login';
                        });
                    }

                    // History clear button
                    const historyClearBtn = $('history_clear_btn');
                    if (historyClearBtn) {
                        historyClearBtn.addEventListener('click', () => {
                             if (confirm('¿Estás seguro que deseas borrar todo el historial de transacciones?')) {
                                 store.state.appData.history = [];
                                 store.save();
                                 renderHistory();
                             }
                        });
                    }
                    
                    // Pagination
                    const paginationPrev = $('pagination_prev');
                    const paginationNext = $('pagination_next');
                    
                    if (paginationPrev) {
                        paginationPrev.addEventListener('click', (e) => {
                            e.preventDefault();
                            if (store.state.historyPage > 0) {
                                store.state.historyPage--;
                                renderHistory();
                            }
                        });
                    }

                    if (paginationNext) {
                        paginationNext.addEventListener('click', (e) => {
                            e.preventDefault();
                            const totalPages = Math.ceil(store.state.appData.history.length / HISTORY_PAGE_SIZE);
                            if (store.state.historyPage < totalPages - 1) {
                                store.state.historyPage++;
                                renderHistory();
                            }
                        });
                    }
                    
                    // Profile form
                    const profileForm = $('profile_form');
                    if (profileForm) {
                        profileForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const user = store.state.user;
                            if (user) {
                                user.name = $('profile_fullname').value;
                                user.email = $('profile_email').value;
                                localStorage.setItem(KEY_USERS, JSON.stringify(
                                    JSON.parse(localStorage.getItem(KEY_USERS)).map(u => u.id === user.id ? user : u)
                                ));
                                localStorage.setItem(KEY_SESSION, JSON.stringify(user));
                                showAlert('profile_alert_box', 'Perfil actualizado con éxito.', 'success');
                                updateAppUI();
                            }
                        });
                    }

                    // Exchange form events
                    const montoInput = $('ex_monto_usd');
                    const accountSelect = $('ex_select_account');
                    const cardSelect = $('ex_select_card');
                    const payBtn = $('ex_pay_btn');

                    if (montoInput) {
                        montoInput.addEventListener('input', updateExchangeSummary);
                    }
                    if (accountSelect) {
                        accountSelect.addEventListener('change', updateExchangeSummary);
                    }
                    if (cardSelect) {
                        cardSelect.addEventListener('change', updateExchangeSummary);
                    }

                    if (payBtn) {
                        payBtn.addEventListener('click', async () => {
                            const tx = store.state.currentTransaction;
                            if (!tx) {
                                showAlert('exchange_alert_box', 'Error: No hay datos de transacción para procesar.', 'danger');
                                return;
                            }

                            if (confirm('¿Confirma que desea realizar este pago?')) {
                                showLoader();
                                const result = await api.payCreditCard(tx.sourceAccountId, tx.cardId, tx.amount);
                                hideLoader();

                                if (result.success) {
                                    showAlert('exchange_alert_box', result.message, 'success');
                                    renderDashboard();
                                    renderAccounts();
                                    renderCards();
                                    renderHistory();
                                    renderExchangeForm();
                                    store.state.currentTransaction = null;
                                } else {
                                    showAlert('exchange_alert_box', result.message, 'danger');
                                }
                            }
                        });
                    }
                };
                
                // --- INITIALIZATION ---
                store.init();
                bindEvents();
                
                // Hide loader immediately when page loads
                hideLoader();
                
                // Router
                router();
                window.addEventListener('hashchange', router);

                // Set current year
                const currentYear = new Date().getFullYear();
                const year1 = $('year1');
                const year2 = $('year2');
                if (year1) year1.innerText = currentYear;
                if (year2) year2.innerText = currentYear;
            });
            </script>
</body>
</html>

